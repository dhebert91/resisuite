/*! qinoa.api - v1.0.0
* https://github.com/cedricfrancoys/qinoa
* Copyright (c) 2015 Cedric Francoys; Licensed GPLv3 */
var qinoa={conf:{user_id:0,user_key:0,user_lang:'fr',content_lang:'fr',DEFAULT_LANG:'fr',QN_DATE_FIRST_DAY_OF_WEEK:2,QN_DATE_FORMAT:'dd/mm/yy',QN_TIME_FORMAT:'hh:mm:ss',QN_DATETIME_FORMAT:'dd/mm/yy hh:mm:ss',QN_NUMERIC_THOUSANDS_SEPARATOR:'.',QN_NUMERIC_DECIMAL_POINT:',',QN_NUMERIC_DECIMAL_PRECISION:2,QN_CURRENCY_SYMBOL:'€',QN_CURRENCY_SYMBOL_INT:'EUR',QN_CURRENCY_FORMAT:'#.##0,00€',UNKNOWN_ERROR:0,MISSING_PARAM:1,INVALID_PARAM:2,SQL_ERROR:4,UNKNOWN_OBJECT:8,NOT_ALLOWED:16},error_codes:{0:"unknown error(s)",1:"one or more mandatory parameters are missing",2:"invalid parameters or wrong values",4:"SQL errors",8:"unknown resource (class, object, view, ...)",16:"action violates some rule or privilege"},simple_types:['boolean','integer','float','string','short_text','text','date','time','datetime','timestamp','selection','binary','many2one'],init:function(a){$.extend(this.conf,a)},create:function(a,b,c){var d=$.Deferred();return $.each(arguments,function(a,b){return null===b?(console.log('0'),d.reject(qinoa.conf.MISSING_PARAM),d.promise()):void 0}),$.ajax({type:'GET',url:'index.php?do=core_objects_create',dataType:'json',data:{fields:b,class_name:a,lang:c},contentType:'application/json; charset=utf-8'}).done(function(a){try{if('object'!=typeof a||'undefined'==typeof a.result||NaN==parseInt(a.result))throw Error(qinoa.conf.UNKNOWN_ERROR);if(a.result<0)throw Error(-a.result);d.resolve(a.result)}catch(b){d.reject(b.message)}}).fail(function(){d.reject(qinoa.conf.UNKNOWN_ERROR)}),d.promise()},read:function(a,b,c,d){var e=$.Deferred();return $.each(arguments,function(a,b){return null===b?(e.reject(qinoa.conf.MISSING_PARAM),e.promise()):void 0}),$.ajax({type:'GET',url:'index.php?get=core_objects_read',dataType:'json',data:{fields:c,class_name:a,ids:b,lang:d},contentType:'application/json; charset=utf-8'}).done(function(a){try{if('object'!=typeof a)throw Error(qinoa.conf.UNKNOWN_ERROR);if('object'!=typeof a.result)throw Error(NaN!=parseInt(a.result)?a.result:qinoa.conf.UNKNOWN_ERROR);e.resolve(a.result)}catch(b){e.reject(b.message)}}).fail(function(){e.reject(qinoa.conf.UNKNOWN_ERROR)}),e.promise()},write:function(a,b,c,d){var e=$.Deferred();return $.each(arguments,function(a,b){return null===b?(e.reject(qinoa.conf.MISSING_PARAM),e.promise()):void 0}),$.ajax({type:'POST',url:'index.php?do=core_objects_write',dataType:'json',data:$.extend({class_name:a,ids:b,lang:d},c),contentType:'application/x-www-form-urlencoded; charset=utf-8'}).done(function(a){try{if('object'!=typeof a)throw Error(qinoa.conf.UNKNOWN_ERROR);if('boolean'!=typeof a.result)throw Error(NaN!=parseInt(a.result)?a.result:qinoa.conf.UNKNOWN_ERROR);e.resolve(a.result)}catch(b){e.reject(b.message)}}).fail(function(){e.reject(qinoa.conf.UNKNOWN_ERROR)}),e.promise()},search:function(a,b,c,d,e,f,g){var h=$.Deferred();if(null===a)h.reject(qinoa.conf.MISSING_PARAM);else{var i={class_name:a,domain:[[[]]],lang:qinoa.conf.DEFAULT_LANG};null!==b&&(i.domain=b),null!==c&&(i.order=c),null!==d&&(i.sort=d),null!==e&&(i.start=e),null!==f&&(i.limit=f),null!==g&&(i.lang=g),$.ajax({type:'GET',url:'index.php?get=core_objects_search',dataType:'json',data:i,contentType:'application/x-www-form-urlencoded; charset=utf-8'}).done(function(a){try{if('object'!=typeof a)throw Error(qinoa.conf.UNKNOWN_ERROR);if('number'==typeof a.result)throw Error(a.result);if('object'!=typeof a.result)throw Error(qinoa.conf.UNKNOWN_ERROR);h.resolve(a.result)}catch(b){h.reject(b.message)}}).fail(function(){h.reject(qinoa.conf.UNKNOWN_ERROR)})}return h.promise()},remove:function(a,b,c){var d=$.Deferred();return $.each(arguments,function(a,b){return null===b?(d.reject(qinoa.conf.MISSING_PARAM),d.promise()):void 0}),$.ajax({type:'GET',url:'index.php?do=core_objects_remove',dataType:'json',data:{class_name:a,ids:b,permanent:Number(Boolean(c))},contentType:'application/json; charset=utf-8'}).done(function(a){try{if('object'!=typeof a)throw Error(qinoa.conf.UNKNOWN_ERROR);if('number'==typeof a.result)throw Error(a.result);if('object'!=typeof a.result)throw Error(qinoa.conf.UNKNOWN_ERROR);d.resolve(a.result)}catch(b){d.reject(b.message)}}).fail(function(){d.reject(qinoa.conf.UNKNOWN_ERROR)}),d.promise()},restore:function(a,b){var c=$.Deferred();return $.ajax({type:'GET',url:'index.php?do=core_objects_restore',async:!1,dataType:'json',data:{object_class:a,ids:b},contentType:'application/json; charset=utf-8',success:function(a){a?c.resolve(a):alert("Unable to remove object : check user's permissions")},error:function(a){}}),c.promise()},get_locale:function(a){var b=$.Deferred();return $.ajax({type:'GET',url:'index.php?get=core_i18n_locale',dataType:'json',data:{locale:a},contentType:'application/json; charset=utf-8'}).done(function(a){try{if('object'!=typeof a)throw Error(qinoa.conf.UNKNOWN_ERROR);if('number'==typeof a.result)throw Error(a.result);if('object'!=typeof a.result)throw Error(qinoa.conf.UNKNOWN_ERROR);$.extend(qinoa.conf,a.result)}catch(c){b.reject(c.message)}}).fail(function(){b.reject(qinoa.conf.UNKNOWN_ERROR)}),b.promise()},lock:function(a,b){if('number'==typeof b&&(b=b.toString()),'number'==typeof a&&(a=a.toString()),32==b.length)for(var c=function(a){var b='0123456789abcdef',c=parseInt(a,16)-1;return 0>c&&(c=15),b.charAt(c)},d=0;d<a.length;++d)pos=parseInt(a.charAt(d)),hex_val=c(b.charAt(pos)),b=b.substring(0,pos)+hex_val+b.substring(pos+1);return b},login:function(a,b){var c=$.Deferred();return $.ajax({type:'GET',url:'index.php?get=core_user_login',async:!0,dataType:'json',data:{login:a,password:b},contentType:'application/json; charset=utf-8',success:function(a){var b=!1;'number'==typeof a.result?qinoa.console.log('Error raised by qinoa.login(): '+qinoa.error_codes[a.result]):b=a.result,c.resolve(b)},error:function(a){c.resolve(!1)}}),c.promise()},user_id:function(){var a=$.Deferred();return qinoa.conf.user_id?a.resolve(qinoa.conf.user_id):$.ajax({type:'GET',url:'index.php?get=core_user_id',async:!0,dataType:'json',contentType:'application/json; charset=utf-8',success:function(b){var c=!1;b.result<0?qinoa.console.log('Error raised by qinoa.user_key(): '+qinoa.error_codes[-b.result]):'number'==typeof b.result&&(c=b.result),qinoa.conf.user_id=c,a.resolve(c)},error:function(b){qinoa.conf.user_id=!1,a.resolve(!1)}}),a.promise()},user_key:function(){var a=$.Deferred();return qinoa.conf.user_key?a.resolve(qinoa.conf.user_key):$.ajax({type:'GET',url:'index.php?get=core_user_key',async:!0,dataType:'json',contentType:'application/json; charset=utf-8',success:function(b){var c=!1;'number'==typeof b.result?qinoa.console.log('Error raised by qinoa.user_key(): '+qinoa.error_codes[b.result]):'string'==typeof b.result&&(c=b.result),qinoa.conf.user_key=c,a.resolve(c)},error:function(b){qinoa.conf.user_key=!1,a.resolve(!1)}}),a.promise()},user_lang:function(){var a=$.Deferred();return qinoa.conf.user_lang?a.resolve(qinoa.conf.user_lang):$.ajax({type:'GET',url:'index.php?get=core_user_lang',async:!0,dataType:'json',contentType:'application/json; charset=utf-8',success:function(b){var c=!1;'number'==typeof b.result?qinoa.console.log('Error raised by qinoa.user_lang(): '+qinoa.error_codes[b.result]):'string'==typeof b.result&&(c=b.result),qinoa.conf.user_lang=c,a.resolve(c)},error:function(b){qinoa.conf.user_lang=!1,a.resolve(!1)}}),a.promise()}};